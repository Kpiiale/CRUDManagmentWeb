@page "/company/reservation"
@using CRUDManagmentWeb.Models.Reservation
@using CRUDManagmentWeb.Services
@inject ReservationService ReservationService
@inject AuthService AuthService
@inject PaymentService PaymentService
@inject CompanyService CompanyService
@inject IJSRuntime JS
@inject NavigationManager Navigation

<div class="user-container">
    <div class="user-card">
        <div class="user-header">
            <h2>Reservas de la Empresa</h2>
        </div>

        <div class="user-table">
            @if (reservations == null)
            {
                <p>Cargando reservas...</p>
            }
            else if (!reservations.Any())
            {
                <p>No hay reservas registradas para esta empresa.</p>
            }
            else
            {
                <table class="user-table-content">
                    <thead>
                        <tr>
                            <th>Actividad</th>
                            <th>Cantidad</th>
                            <th>Precio unitario</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Reservado en</th>
                            <th>Expira en</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var r in reservations)
                        {
                            <tr>
                                <td>@r.ActivityId</td>
                                <td>@r.Quantity</td>
                                <td>@($"{r.UnitPrice} USD")</td>
                                <td>@($"{r.TotalAmount} USD")</td>
                                <td>
                                    <span class="user-badge @(r.Status == "Activo" ? "active" : "inactive")">
                                        @r.Status
                                    </span>
                                </td>
                                <td>@r.ReservedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>@(r.ExpiresAt?.ToString("dd/MM/yyyy HH:mm") ?? "-")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>

        @if (!string.IsNullOrEmpty(notificationMessage))
        {
            <div class="user-notification @notificationType">
                @notificationMessage
            </div>
        }
    </div>
</div>

@code {
    private List<ReservationResponse> reservations = new();
    private int companyId;
    private string? notificationMessage;
    private string? notificationType;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var userId = await GetCurrentUserId();
            var companies = await CompanyService.GetAllAsync();
            var myCompany = companies.FirstOrDefault(c => c.OwnerUserId == userId);
            companyId = myCompany?.Id ?? 0;

            if (companyId == 0)
            {
                ShowNotification("No se encontró empresa asociada al usuario", "error");
                return;
            }

            await LoadReservations();
        }
        catch (Exception ex)
        {
            ShowNotification($"Error al cargar reservas: {ex.Message}", "error");
        }
    }

    private async Task<int> GetCurrentUserId()
    {
        var user = await JS.InvokeAsync<string>("localStorage.getItem", "userId");
        return int.TryParse(user, out var id) ? id : 0;
    }

    private async Task LoadReservations()
    {
        reservations = await ReservationService.GetByCompanyAsync(companyId, page: 1, pageSize: 20);
        StateHasChanged();
    }

    private void ShowNotification(string message, string type)
    {
        notificationMessage = message;
        notificationType = type;
    }
}