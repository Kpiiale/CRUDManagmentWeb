@page "/user/reservation"
@using CRUDManagmentWeb.Models.Reservation
@using CRUDManagmentWeb.Models.Review
@using CRUDManagmentWeb.Services
@inject ReservationService ReservationService
@inject ReviewService ReviewService
@inject AuthService AuthService
@inject PaymentService PaymentService
@inject NavigationManager Navigation

<div class="user-container">
    <div class="user-card">
        <div class="user-header">
            <h2>Tus reservas</h2>
        </div>

        <div class="user-table">
            @if (reservations == null)
            {
                <p>Cargando reservas...</p>
            }
            else if (!reservations.Any())
            {
                <p>No tienes reservas registradas.</p>
            }
            else
            {
                <table class="user-table-content">
                    <thead>
                        <tr>
                            <th>Actividad</th>
                            <th>Cantidad</th>
                            <th>Precio unitario</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Reservado en</th>
                            <th>Expira en</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var r in reservations)
                        {
                            <tr>
                                <td>@r.ActivityId</td>
                                <td>@r.Quantity</td>
                                <td>@($"{r.UnitPrice} USD")</td>
                                <td>@($"{r.TotalAmount} USD")</td>
                                <td>
                                    <span class="reserve-badge @(r.Status == "Confirmed" ? "status-confirmed" :
                                                                                                                                    r.Status == "Cancelled" ? "status-cancelled" :
                                                                                                                                    "status-pending")">
                                @r.Status
                            </span>
                        </td>
                        <td>@r.ReservedAt.ToString("dd/MM/yyyy HH:mm")</td>
                        <td>@(r.ExpiresAt?.ToString("dd/MM/yyyy HH:mm") ?? "-")</td>
                        <td>
                            @if (r.Status == "Pending")
                                    {
                                        <button class="user-btn small pay" @onclick="() => IniciarPago(r.Id)">
                                            Pagar
                                        </button>
                                    }
                                    else if (r.Status == "Confirmed" && !YaCalificado(r.ActivityId))
                                    {
                                        <button class="user-btn small rate"
                                                @onclick="() => AbrirPopup(r.ActivityId)">
                                            Calificar
                                        </button>
                                    }
                                    else if (r.Status == "Confirmed" && YaCalificado(r.ActivityId))
                                    {
                                        <span style="color:green; font-weight:600;">
                                             Calificado
                                        </span>
                                    }

                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="user-notification">
                @message
            </div>
        }
    </div>
</div>

<!-- Fragmento de popup actualizado -->
@if (mostrarPopup)
{
    <div class="popup-overlay">
        <div class="popup-content" style="max-width:420px;">
            <h3>Califica la actividad</h3>

            <div class="star-slider-container">
                <input type="range"
                       min="1"
                       max="5"
                       step="1"
                       @bind="ratingSeleccionado"
                       class="star-slider" />

                <div class="star-bg">
                    ★★★★★
                </div>

                <div class="star-fg" style="width:@(ratingSeleccionado * 20)%">
                    ★★★★★
                </div>
            </div>

            <div style="text-align:center; font-size:13px; color:#666;">
                @ratingSeleccionado de 5 estrellas
            </div>


            <div style="margin-bottom:8px; font-size:13px; color:#555; text-align:center;">
                Selecciona de 1 a 5 estrellas
            </div>

            <div style="margin:10px 0;">
                <input type="text"
                       placeholder="Título de tu reseña"
                       @bind="tituloReview"
                       class="user-input"
                       style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;" />
            </div>

            <div style="margin-bottom:14px;">
                <textarea placeholder="Escribe tu comentario"
                          @bind="comentarioReview"
                          rows="4"
                          class="user-input"
                          style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;"></textarea>
            </div>

            <button class="user-btn small confirm"
                    @onclick="EnviarCalificacion"
                    disabled="@(ratingSeleccionado < 1 || ratingSeleccionado > 5 || string.IsNullOrWhiteSpace(tituloReview) || string.IsNullOrWhiteSpace(comentarioReview))">
                Guardar
            </button>
            <button class="user-btn small cancel" @onclick="CerrarPopup">Cancelar</button>
        </div>
    </div>
}

@code {
    private List<ReservationResponse>? reservations;
    private string? message;

    // popup
    private bool mostrarPopup = false;
    private int actividadSeleccionada;
    private string tituloReview = string.Empty;
    private string comentarioReview = string.Empty;
    private int ratingSeleccionado = 0;
    private HashSet<int> actividadesCalificadas = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var currentUser = await AuthService.GetCurrentUserAsync();
            if (currentUser is null)
            {
                message = "No se pudo obtener el usuario actual.";
                return;
            }

            reservations = await ReservationService.GetByUserAsync(currentUser.Id);

            if (reservations != null && reservations.Any())
            {
                foreach (var r in reservations)
                {
                    var reviews = await ReviewService.GetByActivityAsync(r.ActivityId);

                    if (reviews != null && reviews.Reviews.Any(x => x.UserId == currentUser.Id))
                    {
                        actividadesCalificadas.Add(r.ActivityId);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            message = $"Error al cargar reservas: {ex.Message}";
        }
    }


    private async Task IniciarPago(long reservationId)
    {
        try
        {
            var url = await PaymentService.CreateCheckoutSessionAsync(reservationId);
            if (!string.IsNullOrEmpty(url))
            {
                Navigation.NavigateTo(url, forceLoad: true);
            }
            else
            {
                message = "No se pudo iniciar el pago.";
            }
        }
        catch (Exception ex)
        {
            message = $"Error al iniciar pago: {ex.Message}";
        }
    }

    private void AbrirPopup(int activityId)
    {
        actividadSeleccionada = activityId;
        ratingSeleccionado = 0;
        mostrarPopup = true;
    }

    private void CerrarPopup()
    {
        mostrarPopup = false;
    }

    private async Task EnviarCalificacion()
    {
        if (ratingSeleccionado < 1 || ratingSeleccionado > 5)
        {
            message = "La calificación debe ser entre 1 y 5 estrellas.";
            return;
        }

        if (string.IsNullOrWhiteSpace(tituloReview) || string.IsNullOrWhiteSpace(comentarioReview))
        {
            message = "Debes escribir un título y un comentario.";
            return;
        }

        try
        {
            var request = new AddReviewRequest
            {
                ActivityId = actividadSeleccionada,
                Rating = (byte)ratingSeleccionado,
                Title = tituloReview,
                Comment = comentarioReview
            };

            var result = await ReviewService.AddAsync(actividadSeleccionada, request);

            if (result != null)
            {
                actividadesCalificadas.Add(actividadSeleccionada);
                message = "Calificación guardada correctamente ✅";
            }
            else
            {
                message = "Error al guardar la calificación.";
            }
        }
        catch (Exception ex)
        {
            message = $"Error al calificar: {ex.Message}";
        }
        finally
        {
            mostrarPopup = false;
            tituloReview = string.Empty;
            comentarioReview = string.Empty;
            ratingSeleccionado = 0;
        }
    }


    private void SeleccionarRating(int valor)
    {
        ratingSeleccionado = valor;
        StateHasChanged(); // Fuerza el refresco del componente
    }

    private void IncrementRating()
    {
        if (ratingSeleccionado < 5) ratingSeleccionado++;
        else ratingSeleccionado = 5;
    }

    private void DecrementRating()
    {
        if (ratingSeleccionado > 1) ratingSeleccionado--;
        else ratingSeleccionado = 1;
    }

    private bool YaCalificado(int activityId) => actividadesCalificadas.Contains(activityId);
}
