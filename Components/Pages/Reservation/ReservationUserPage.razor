@page "/user/reservation"
@using CRUDManagmentWeb.Models.Reservation
@using CRUDManagmentWeb.Services
@inject ReservationService ReservationService
@inject AuthService AuthService
@inject PaymentService PaymentService
@inject NavigationManager Navigation


<div class="user-container">
    <div class="user-card">
        <div class="user-header">
            <h2>Tus reservas</h2>
        </div>

        <div class="user-table">
            @if (reservations == null)
            {
                <p>Cargando reservas...</p>
            }
            else if (!reservations.Any())
            {
                <p>No tienes reservas registradas.</p>
            }
            else
            {
                <table class="user-table-content">
                    <thead>
                        <tr>
                            <th>Actividad</th>
                            <th>Cantidad</th>
                            <th>Precio unitario</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Reservado en</th>
                            <th>Expira en</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var r in reservations)
                        {
                            <tr>
                                <td>@r.ActivityId</td>
                                <td>@r.Quantity</td>
                                <td>@($"{r.UnitPrice} USD")</td>
                                <td>@($"{r.TotalAmount} USD")</td>
                                <td>
                                    <span class="user-badge @(r.Status == "Activo" ? "active" : "inactive")">
                                        @r.Status
                                    </span>
                                </td>
                                <td>@r.ReservedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>@(r.ExpiresAt?.ToString("dd/MM/yyyy HH:mm") ?? "-")</td>
                                <td>
                                    <button class="user-btn small pay" @onclick="() => IniciarPago(r.Id)">
                                        Pagar
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="user-notification">
                @message
            </div>
        }
    </div>
</div>
@code {
    private List<ReservationResponse>? reservations;
    private string? message;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var currentUser = await AuthService.GetCurrentUserAsync();
            if (currentUser is null)
            {
                message = "No se pudo obtener el usuario actual.";
                return;
            }

            reservations = await ReservationService.GetByUserAsync(currentUser.Id);
        }
        catch (Exception ex)
        {
            message = $"Error al cargar reservas: {ex.Message}";
        }
    }

    private async Task IniciarPago(long reservationId)
    {
        try
        {
            var url = await PaymentService.CreateCheckoutSessionAsync(reservationId);
            if (!string.IsNullOrEmpty(url))
            {
                Navigation.NavigateTo(url, forceLoad: true); // redirige a Stripe Checkout
            }
            else
            {
                message = "No se pudo iniciar el pago.";
            }
        }
        catch (Exception ex)
        {
            message = $"Error al iniciar pago: {ex.Message}";
        }
    }
}