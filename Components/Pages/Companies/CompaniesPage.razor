@page "/admin/companies"
@using CRUDManagmentWeb.Components.Shared
@using CRUDManagmentWeb.Models.Company
@using CRUDManagmentWeb.Models.User
@inject CRUDManagmentWeb.Services.CompanyService CompanyService
@inject CRUDManagmentWeb.Services.UserService UserService
@inject IJSRuntime JS
@using CRUDManagmentWeb.Components.Pages.Auth
@using Microsoft.AspNetCore.Authorization
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin")]
<div class="user-container">
        <div class="user-card">
            <div class="user-header">
                <h2>Gestión de Empresas</h2>
            </div>

            <div class="user-form">
                <h3>@(isEditMode ? "Editar Empresa" : "Agregar Nueva Empresa")</h3>

                <EditForm Model="@companyForm" OnValidSubmit="@HandleSubmit">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="user-grid">
                        <div class="user-group">
                            <label class="user-label">Nombre</label>
                            <div class="user-input-wrapper">
                                <InputText @bind-Value="companyForm.Name" placeholder="Nombre de la compañía" />
                            </div>
                        </div>

                        <div class="user-group">
                            <label class="user-label">Descripción</label>
                            <div class="user-input-wrapper">
                                <InputText @bind-Value="companyForm.Description" placeholder="Descripción breve" />
                            </div>
                        </div>

                        <div class="user-group">
                            <label class="user-label">Dueño (Usuarios tipo Company)</label>
                            <div class="user-input-wrapper">
                                <InputSelect @bind-Value="companyForm.OwnerUserId">
                                    <option value="0">-- Seleccione un usuario --</option>
                                    @foreach (var user in companyUsers)
                                    {
                                        <option value="@user.Id">@($"{user.Username} ({user.Email})")</option>
                                    }
                                </InputSelect>
                            </div>
                        </div>

                        <div class="user-group">
                            <label class="user-label">Activa</label>
                            <div class="checkbox-wrapper">
                                <InputCheckbox @bind-Value="companyForm.IsActive" />
                                <label class="checkbox-label">Compañía activa</label>
                            </div>
                        </div>
                    </div>

                    <div class="user-actions">
                        <button class="user-btn" type="submit">
                            <span class="btn-text">@(isEditMode ? "Actualizar" : "Crear")</span>
                            <span class="btn-loader">
                                <span class="loader-bar"></span>
                                <span class="loader-bar"></span>
                                <span class="loader-bar"></span>
                            </span>
                        </button>

                        @if (isEditMode)
                        {
                            <button type="button" class="user-btn cancel" @onclick="CancelEdit">Cancelar</button>
                        }
                    </div>
                @if (!string.IsNullOrEmpty(notificationMessage))
                {
                    <div class="user-notification @notificationType">
                        @notificationMessage
                    </div>
                }
                </EditForm>
            </div>

            <div class="user-table">
                <h3>Listado de Empresas</h3>

                @if (companies == null)
                {
                    <p>Cargando...</p>
                }
                else if (!companies.Any())
                {
                    <p>No hay empresas registradas.</p>
                }
                else
                {
                    <table class="user-table-content">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Descripción</th>
                                <th>Rating</th>
                                <th>Activa</th>
                                <th>Creada</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var c in companies)
                            {
                                <tr>
                                    <td>@c.Name</td>
                                    <td>@c.Description</td>
                                    <td>@($"{c.AvgRating:F1} ⭐ ({c.RatingCount})")</td>
                                    <td>
                                        <span class="user-badge @(c.IsActive ? "active" : "inactive")">
                                            @(c.IsActive ? "Activo" : "Inactivo")
                                        </span>
                                    </td>
                                    <td>@c.CreatedAt.ToString("dd/MM/yyyy")</td>
                                    <td>
                                        <button class="user-btn small edit" @onclick="@(() => EditCompany(c))">✏️</button>
                                        <button class="user-btn small delete" @onclick="@(() => DeleteCompany(c.Id))">🗑️</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    </div>

@code {
    private List<CompanyDto>? companies;
    private List<UserDto> companyUsers = new(); 
    private CompanyFormModel companyForm = new();
    private bool isEditMode = false;
    private int editCompanyId;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadCompanyUsers();
            await LoadCompanies();
        }
    }

    private async Task LoadCompanies()
    {
        try
        {
            companies = await CompanyService.GetAllAsync() ?? new List<CompanyDto>();
            Console.WriteLine($"Compañías cargadas: {companies.Count}");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar compañías: {ex.Message}");
        }
    }

    private async Task LoadCompanyUsers()
    {
        try
        {
            var allUsers = await UserService.GetAllAsync();
            companyUsers = allUsers?.Where(u => u.Role.Equals("Company", StringComparison.OrdinalIgnoreCase)).ToList() ?? new();
            Console.WriteLine($"Usuarios tipo Company cargados: {companyUsers.Count}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar usuarios tipo Company: {ex.Message}");
        }
    }

    private async Task HandleSubmit()
    {
        bool success;

        if (isEditMode)
        {
            var updateRequest = new UpdateCompanyRequest(
                companyForm.Name,
                companyForm.Description,
                companyForm.IsActive
            );

            success = await CompanyService.UpdateAsync(editCompanyId, updateRequest);
        }
        else
        {
            var createRequest = new CreateCompanyRequest(
                companyForm.Name,
                companyForm.Description,
                companyForm.OwnerUserId
            );

            success = await CompanyService.CreateAsync(createRequest);
        }

        if (success)
        {
            ShowNotification("Empresa guardada correctamente", "success");
            await LoadCompanies();
            CancelEdit();
        }
        else
        {
            ShowNotification("No se pudo guardar la empresa", "error");
        }
    }

    private void EditCompany(CompanyDto company)
    {
        isEditMode = true;
        editCompanyId = company.Id;

        companyForm = new CompanyFormModel
        {
            Name = company.Name,
            Description = company.Description ?? "",
            OwnerUserId = company.OwnerUserId,
            IsActive = company.IsActive
        };
    }

    private void CancelEdit()
    {
        isEditMode = false;
        editCompanyId = 0;
        companyForm = new();
    }

    private async Task DeleteCompany(int id)
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "¿Eliminar esta compañía?");
        if (confirmed)
        {
            var success = await CompanyService.DeleteAsync(id);
            if (success)
            {
                ShowNotification("Empresa eliminada correctamente", "success");
                await LoadCompanies();
            }
        }
    }
    private string notificationMessage = "";
    private string notificationType = ""; // success, error

    private void ShowNotification(string message, string type)
    {
        notificationMessage = message;
        notificationType = type;

        // Ocultar después de 3 segundos
        _ = Task.Run(async () =>
        {
            await Task.Delay(3000);
            notificationMessage = "";
            notificationType = "";
            InvokeAsync(StateHasChanged);
        });
    }
}
