@page "/company/employees"
@using CRUDManagmentWeb.Components.Shared
@using CRUDManagmentWeb.Models.Employee
@inject CRUDManagmentWeb.Services.EmployeeService EmployeeService
@inject CRUDManagmentWeb.Services.CompanyService CompanyService
@inject IJSRuntime JS
@using CRUDManagmentWeb.Components.Pages.Auth
@using Microsoft.AspNetCore.Authorization
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Company")]

    <div class="user-container">
        <div class="user-card">
            <div class="user-header">
                <h2>Gestión de Empleados</h2>
            </div>

            <div class="user-form">
                <h3>@(isEditMode ? "Editar Empleado" : "Agregar Nuevo Empleado")</h3>

                <EditForm Model="@employeeForm" OnValidSubmit="@HandleSubmit">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="user-grid">
                        <div class="user-group">
                            <label class="user-label">Correo</label>
                            <div class="user-input-wrapper">
                                <InputText @bind-Value="employeeForm.Email" placeholder="Correo electrónico" />
                            </div>
                            <ValidationMessage For="@(() => employeeForm.Email)" />
                        </div>

                        <div class="user-group">
                            <label class="user-label">Rol</label>
                            <div class="user-input-wrapper">
                                <InputText @bind-Value="employeeForm.RoleInCompany" placeholder="Rol en la empresa" />
                            </div>
                            <ValidationMessage For="@(() => employeeForm.RoleInCompany)" />
                        </div>

                        @if (!isEditMode)
                        {
                            <div class="user-group">
                                <label class="user-label">Usuario</label>
                                <div class="user-input-wrapper">
                                    <InputText @bind-Value="employeeForm.Username" placeholder="Nombre de usuario" />
                                </div>
                                <ValidationMessage For="@(() => employeeForm.Username)" />
                            </div>

                            <div class="user-group">
                                <label class="user-label">Contraseña</label>
                                <div class="user-input-wrapper">
                                    <InputText type="password" @bind-Value="employeeForm.Password" placeholder="Contraseña" />
                                </div>
                                <ValidationMessage For="@(() => employeeForm.Password)" />
                            </div>
                        }

                        @if (isEditMode)
                        {
                            <div class="user-group">
                                <label class="user-label">Cambiar contraseña</label>
                                <div class="checkbox-wrapper">
                                    <InputCheckbox @bind-Value="changePassword" />
                                    <label class="checkbox-label">Actualizar contraseña</label>
                                </div>
                            </div>

                            @if (changePassword)
                            {
                                <div class="user-group">
                                    <label class="user-label">Nueva contraseña</label>
                                    <div class="user-input-wrapper">
                                        <InputText type="password" @bind-Value="employeeForm.Password" placeholder="Nueva contraseña" />
                                    </div>
                                    <ValidationMessage For="@(() => employeeForm.Password)" />
                                </div>
                            }
                        }
                    </div>

                    <div class="user-actions">
                        <button class="user-btn" type="submit">
                            <span class="btn-text">@(isEditMode ? "Actualizar" : "Crear")</span>
                            <span class="btn-loader">
                                <span class="loader-bar"></span>
                                <span class="loader-bar"></span>
                                <span class="loader-bar"></span>
                            </span>
                        </button>

                        @if (isEditMode)
                        {
                            <button type="button" class="user-btn cancel" @onclick="CancelEdit">Cancelar</button>
                        }
                    </div>
                </EditForm>
            </div>

            <div class="user-table">
                <h3>📋 Empleados Registrados</h3>

                @if (employees == null)
                {
                    <p>Cargando...</p>
                }
                else if (!employees.Any())
                {
                    <p>No hay empleados registrados.</p>
                }
                else
                {
                    <table class="user-table-content">
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Correo</th>
                                <th>Rol</th>
                                <th>Activo</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var e in employees)
                            {
                                <tr>
                                    <td>@e.Username</td>
                                    <td>@e.Email</td>
                                    <td>@e.RoleInCompany</td>
                                    <td>
                                        <span class="user-badge @(e.IsActive ? "active" : "inactive")">
                                            @(e.IsActive ? "Activo" : "Inactivo")
                                        </span>
                                    </td>
                                    <td>
                                        <button class="user-btn small edit" @onclick="@(() => EditEmployee(e))">✏️</button>
                                        <button class="user-btn small delete" @onclick="@(() => DeleteEmployee(e.Id))">🗑️</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    </div>

@code {
    private List<EmployeeDto> employees = new();
    private EmployeeFormModel employeeForm = new();
    private int companyId;
    private bool isEditMode = false;
    private int editEmployeeId;
    private bool changePassword = false;
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                await LoadCompanyId();
                if (companyId == 0)
                {
                    await JS.InvokeVoidAsync("alert", "No se encontró empresa asociada al usuario");
                    return;
                }

                await LoadEmployees();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error en carga inicial: {ex.Message}");
                await JS.InvokeVoidAsync("alert", $"Error al cargar la página: {ex.Message}");
            }
        }
    }

    private async Task LoadCompanyId()
    {
        var userId = await GetCurrentUserId();
        var companies = await CompanyService.GetAllAsync();
        var myCompany = companies.FirstOrDefault(c => c.OwnerUserId == userId);
        companyId = myCompany?.Id ?? 0;
    }

    private async Task<int> GetCurrentUserId()
    {
        var user = await JS.InvokeAsync<string>("localStorage.getItem", "userId");
        return int.TryParse(user, out var id) ? id : 0;
    }

    private async Task LoadEmployees()
    {
        employees = await EmployeeService.GetAllAsync(companyId);
        StateHasChanged();
    }

    private async Task HandleSubmit()
    {
        try
        {
            if (isEditMode)
            {
                var updateRequest = new UpdateEmployeeRequest(
                    employeeForm.Email,
                    employeeForm.RoleInCompany,
                    employeeForm.IsActive,
                    string.IsNullOrWhiteSpace(employeeForm.Password) ? null : employeeForm.Password
                );
                var success = await EmployeeService.UpdateAsync(editEmployeeId, updateRequest);

                if (success)
                {
                    await JS.InvokeVoidAsync("alert", "Empleado actualizado");
                    CancelEdit();
                    await LoadEmployees();
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", "Error al actualizar el empleado");
                }
            }
            else
            {
                var createRequest = new CreateEmployeeRequest(
                    employeeForm.Username,
                    employeeForm.Email,
                    employeeForm.Password,
                    employeeForm.RoleInCompany
                );

                var success = await EmployeeService.CreateAsync(companyId, createRequest);

                if (success)
                {
                    await JS.InvokeVoidAsync("alert", "Empleado creado correctamente");
                    employeeForm = new();
                    await LoadEmployees();
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", "Error al crear el empleado");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error en HandleSubmit: {ex.Message}");
            await JS.InvokeVoidAsync("alert", $"Error inesperado: {ex.Message}");
        }
    }

    private void EditEmployee(EmployeeDto employee)
    {
        isEditMode = true;
        editEmployeeId = employee.Id;

        employeeForm = new EmployeeFormModel
        {
            Username = employee.Username,
            Email = employee.Email,
            Password = "",
            RoleInCompany = employee.RoleInCompany,
            IsActive = employee.IsActive
        };
    }

    private void CancelEdit()
    {
        isEditMode = false;
        editEmployeeId = 0;
        employeeForm = new();
    }

    private async Task DeleteEmployee(int id)
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "¿Eliminar este empleado?");
        if (confirmed)
        {
            var success = await EmployeeService.DeleteAsync(id);
            if (success)
            {
                await JS.InvokeVoidAsync("alert", "Empleado eliminado");
                await LoadEmployees();
            }
        }
    }
}