@page "/activities/select-category/{ActivityId:int}"
@using CRUDManagmentWeb.Components.Pages.Auth
@using CRUDManagmentWeb.Models.Category
@inject CRUDManagmentWeb.Services.CategoryService CategoryService
@inject CRUDManagmentWeb.Services.ActivityCategoryService ActivityCategoryService
@inject IJSRuntime JS
@inject NavigationManager Nav
@rendermode InteractiveServer


<PageTitle>Asignar Categoría</PageTitle>

<h3>Asignar Categoría a la Actividad #@ActivityId</h3>
<hr />

@if (allCategories is null)
{
    <p><em>Cargando categorías...</em></p>
}
else
{
    <div class="mb-3">
        <label class="form-label">Selecciona una categoría:</label>
        <select class="form-select" @bind="selectedCategoryId">
            <option value="0">-- Elige una opción --</option>
            @foreach (var category in allCategories)
            {
                <option value="@category.Id">@category.Name</option>
            }
        </select>
    </div>

    <button class="btn btn-primary" @onclick="HandleSave" disabled="@(selectedCategoryId == 0)">
        Asignar y Volver
    </button>
    <button class="btn btn-secondary" @onclick="GoBack">
        Cancelar
    </button>
}


@code {
    [Parameter]
    public int ActivityId { get; set; }

    private List<CategoryDto>? allCategories;
    private int selectedCategoryId;

    /// <summary>
    /// Con @rendermode InteractiveServer, OnInitializedAsync se ejecuta en un
    /// entorno interactivo, por lo que las llamadas a servicios que usan
    /// IJSRuntime son completamente seguras aquí.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        allCategories = await CategoryService.GetAllAsync();
    }

    private async Task HandleSave()
    {
        if (selectedCategoryId == 0) return;

        await ActivityCategoryService.AddCategoryAsync(ActivityId, selectedCategoryId);

        GoBack();
    }

    private void GoBack()
    {
        Nav.NavigateTo("/company/activities");
    }
}