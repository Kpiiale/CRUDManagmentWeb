@page "/admin/categories"
@using CRUDManagmentWeb.Components.Shared
@using CRUDManagmentWeb.Models.Category
@using Microsoft.AspNetCore.Authorization
@inject CRUDManagmentWeb.Services.CategoryService CategoryService
@inject IJSRuntime JS
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin")]

<div class="user-container">
        <div class="user-card">
            <div class="user-header">
                <h2>Gestión de Categorías</h2>
            </div>

            <div class="user-form">
                <h3>@(isEditMode ? "Editar Categoría" : "Agregar Nueva Categoría")</h3>

                <EditForm Model="@categoryForm" OnValidSubmit="@HandleSubmit">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="user-grid">
                        <div class="user-group">
                            <label class="user-label">Nombre</label>
                            <div class="user-input-wrapper">
                                <InputText @bind-Value="categoryForm.Name" placeholder="Nombre de la categoría" />
                            </div>
                        </div>
                    </div>

                    <div class="user-actions">
                        <button class="user-btn" type="submit">
                            <span class="btn-text">@(isEditMode ? "Actualizar" : "Crear")</span>
                            <span class="btn-loader">
                                <span class="loader-bar"></span>
                                <span class="loader-bar"></span>
                                <span class="loader-bar"></span>
                            </span>
                        </button>

                        @if (isEditMode)
                        {
                            <button type="button" class="user-btn cancel" @onclick="CancelEdit">Cancelar</button>
                        }
                    </div>
                @if (!string.IsNullOrEmpty(notificationMessage))
                {
                    <div class="user-notification @notificationType">
                        @notificationMessage
                    </div>
                }
                </EditForm>
            </div>

            <div class="user-table">
                <h3>📋 Lista de Categorías</h3>

                @if (categories == null)
                {
                    <p>Cargando...</p>
                }
                else if (!categories.Any())
                {
                    <p>No hay categorías registradas.</p>
                }
                else
                {
                    <table class="user-table-content">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Creada por</th>
                                <th>Fecha de creación</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var c in categories)
                            {
                                <tr>
                                    <td>@c.Name</td>
                                    <td>@c.CreatedBy</td>
                                    <td>@c.CreatedAt.ToString("dd/MM/yyyy")</td>
                                    <td>
                                        <button class="user-btn small edit" @onclick="@(() => EditCategory(c))">✏️</button>
                                        <button class="user-btn small delete" @onclick="@(() => DeleteCategory(c.Id))">🗑️</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    </div>

@code {
    private List<CategoryDto>? categories;
    private UpdateCategoryRequest categoryForm = new();
    private bool isEditMode = false;
    private int editId;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadCategories();
            StateHasChanged();
        }
    }

    private async Task LoadCategories()
    {
        categories = await CategoryService.GetAllAsync();
    }

    private async Task HandleSubmit()
    {
        bool success;

        if (isEditMode)
        {
            success = await CategoryService.UpdateAsync(editId, categoryForm);
        }
        else
        {
            var createRequest = new CreateCategoryRequest { Name = categoryForm.Name };
            success = await CategoryService.CreateAsync(createRequest);
        }

        if (success)
        {
            ShowNotification("Categoría guardada correctamente", "success");
            await LoadCategories();
            CancelEdit();
        }
        else
        {
            ShowNotification("No se pudo guardar la categoría", "error");
        }
        Console.WriteLine($"Modo edición: {isEditMode}, ID: {editId}, Nombre: {categoryForm.Name}");
    }

    private void EditCategory(CategoryDto category)
    {
        isEditMode = true;
        editId = category.Id;
        categoryForm.Name = category.Name;
    }

    private void CancelEdit()
    {
        isEditMode = false;
        editId = 0;
        categoryForm = new();
    }

    private async Task DeleteCategory(int id)
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "¿Eliminar esta categoría?");
        if (confirmed)
        {
            var success = await CategoryService.DeleteAsync(id);
            if (success)
            {
                ShowNotification("Categoría eliminada correctamente", "success");
                await LoadCategories();
            }
        }
    }
    private string notificationMessage = "";
    private string notificationType = ""; // success, error

    private void ShowNotification(string message, string type)
    {
        notificationMessage = message;
        notificationType = type;

        // Ocultar después de 3 segundos
        _ = Task.Run(async () =>
        {
            await Task.Delay(3000);
            notificationMessage = "";
            notificationType = "";
            InvokeAsync(StateHasChanged);
        });
    }
}
