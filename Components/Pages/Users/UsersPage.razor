@page "/admin/users"
@using CRUDManagmentWeb.Components.Pages.Auth
@using CRUDManagmentWeb.Components.Shared
@using CRUDManagmentWeb.Models.User
@using Microsoft.AspNetCore.Authorization
@inject CRUDManagmentWeb.Services.UserService UserService
@inject IJSRuntime JS
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin")] 



<div class="user-container">
        <div class="user-card">
            <div class="user-header">
                <h2>Gestión de Usuarios</h2>
            </div>
            <div class="user-form">
                <h3>@(isEditMode ? "Editar Usuario" : "Agregar Usuario")</h3>

                <EditForm Model="@userForm" OnValidSubmit="@HandleSubmit">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="user-grid">
                        <div class="user-group">
                            <label class="user-label">Nombre</label>
                            <div class="user-input-wrapper">
                                <InputText @bind-Value="userForm.Username" placeholder="Nombre de usuario" />
                            </div>
                        </div>

                        <div class="user-group">
                            <label class="user-label">Correo</label>
                            <div class="user-input-wrapper">
                                <InputText @bind-Value="userForm.Email" type="email" placeholder="Correo electrónico" />
                            </div>
                        </div>

                        <div class="user-group">
                            <label class="user-label">Rol</label>
                            <div class="user-input-wrapper">
                                <InputSelect @bind-Value="userForm.Role">
                                    <option value="">Selecciona un rol</option>
                                    <option value="Admin">Admin</option>
                                    <option value="Company">Company</option>
                                    <option value="User">User</option>
                                </InputSelect>
                            </div>
                        </div>

                        <div class="user-group">
                            <label class="user-label">Contraseña</label>
                            <div class="user-input-wrapper">
                                <InputText @bind-Value="userForm.Password" type="password" placeholder="Contraseña" />
                            </div>
                        </div>
                        <div class="user-group">
                            <label class="user-label">Estado</label>
                            <div class="checkbox-wrapper">
                                <InputCheckbox @bind-Value="userForm.IsActive" />
                                <label class="checkbox-label">Usuario activo</label>
                            </div>
                        </div>
                    </div>
               
                    <div class="user-actions">
                        <button class="user-btn" type="submit">
                            <span class="btn-text">@(isEditMode ? "Actualizar" : "Crear")</span>
                            <span class="btn-loader">
                                <span class="loader-bar"></span>
                                <span class="loader-bar"></span>
                                <span class="loader-bar"></span>
                            </span>
                        </button>

                        @if (isEditMode)
                        {
                            <button type="button" class="user-btn cancel" @onclick="CancelEdit">Cancelar</button>
                        }
                    </div>
                @if (!string.IsNullOrEmpty(notificationMessage))
                {
                    <div class="user-notification @notificationType">
                        @notificationMessage
                    </div>
                }
                </EditForm>
            </div>
            <div class="user-table">
                <h3>Usuarios registrados</h3>

                @if (users == null)
                {
                    <p>Cargando...</p>
                }
                else if (!users.Any())
                {
                    <p>No hay usuarios registrados.</p>
                }
                else
                {
                    <table class="user-table-content">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Activo</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var u in users)
                            {
                                <tr>
                                    <td>@u.Username</td>
                                    <td>@u.Email</td>
                                    <td>@u.Role</td>
                                    <td>
                                        <span class="user-badge @(u.IsActive ? "active" : "inactive")">
                                            @(u.IsActive ? "Activo" : "Inactivo")
                                        </span>
                                    </td>
                                    <td>
                                        <button class="user-btn small edit" @onclick="@(() => EditUser(u))">✏️ Editar</button>
                                        <button class="user-btn small delete" @onclick="@(() => DeleteUser(u.Id))">🗑️ Eliminar</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    </div>


@code {
    private List<UserDto>? users;
    private UserFormModel userForm = new();
    private bool isEditMode = false;
    private int editUserId;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
            await LoadUsers();
    }

    private async Task LoadUsers()
    {
        try
        {
            users = await UserService.GetAllAsync() ?? new List<UserDto>();
            Console.WriteLine($"Usuarios cargados: {users.Count}");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar usuarios: {ex.Message}");
        }
    }

    private async Task HandleSubmit()
    {
        bool success;

        if (isEditMode)
        {
            var updateRequest = new UpdateUserRequest(
                userForm.Email,
                userForm.Role,
                string.IsNullOrWhiteSpace(userForm.Password) ? null : userForm.Password,
                userForm.IsActive
            );

            success = await UserService.UpdateAsync(editUserId, updateRequest);
        }
        else
        {
            var createRequest = new CreateUserRequest(
                userForm.Username,
                userForm.Email,
                userForm.Password,
                userForm.Role,
                userForm.IsActive
            );

            success = await UserService.CreateAsync(createRequest);
        }

        if (success)
        {
            ShowNotification("Usuario guardado correctamente", "success");
            await LoadUsers();
            CancelEdit();
        }
        else
        {
            ShowNotification("No se pudo eliminar el usuario", "error");

        }
    }

    private void EditUser(UserDto user)
    {
        isEditMode = true;
        editUserId = user.Id;

        userForm = new UserFormModel
        {
            Username = user.Username,
            Email = user.Email,
            Role = user.Role,
            Password = "",
            IsActive = user.IsActive
        };
    }

    private void CancelEdit()
    {
        isEditMode = false;
        editUserId = 0;
        userForm = new();
    }

    private async Task DeleteUser(int id)
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "¿Eliminar este usuario?");
        if (confirmed)
        {
            var success = await UserService.DeleteAsync(id);
            if (success)
            {
                ShowNotification("Usuario eliminado correctamente", "success");
                await LoadUsers();
            }
            else
            {
                ShowNotification("No se pudo eliminar el usuario", "error");
            }
        }
    }

    private string notificationMessage = "";
    private string notificationType = ""; // success, error

    private void ShowNotification(string message, string type)
    {
        notificationMessage = message;
        notificationType = type;

        // Ocultar después de 3 segundos
        _ = Task.Run(async () =>
        {
            await Task.Delay(3000);
            notificationMessage = "";
            notificationType = "";
            InvokeAsync(StateHasChanged);
        });
    }
}
