@using CRUDManagmentWeb.Services.Auth
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JS

<nav class="main-navbar">
    <ul class="main-navbar-list">
        <li><a @onclick="IrInicio">Inicio</a></li>

        @if (isAuthenticated)
        {
            @if (userRole?.ToLower() == "user")
            {
                <li><a href="/user/reservation">Tus reservas</a></li>
            }

            <li><a @onclick="Logout">Cerrar sesión</a></li>
        }
        else
        {
            <li><a href="/login">Iniciar sesión</a></li>
        }
    </ul>
</nav>

@code {
    private bool isAuthenticated;
    private string? userRole;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        isAuthenticated = user.Identity?.IsAuthenticated ?? false;
        userRole = user.FindFirst(ClaimTypes.Role)?.Value;
    }

    private void IrInicio()
    {
        if (!isAuthenticated || string.IsNullOrWhiteSpace(userRole))
        {
            Navigation.NavigateTo("/");
            return;
        }

        switch (userRole.ToLower())
        {
            case "admin":
                Navigation.NavigateTo("/admin");
                break;
            case "employee":
                Navigation.NavigateTo("/employee");
                break;
            case "company":
                Navigation.NavigateTo("/company");
                break;
            case "user":
                Navigation.NavigateTo("/homeuser");
                break;
            default:
                Navigation.NavigateTo("/");
                break;
        }
    }

    private async Task Logout()
    {
        await JS.InvokeVoidAsync("localStorage.removeItem", "authToken");
        await JS.InvokeVoidAsync("localStorage.removeItem", "username");
        await JS.InvokeVoidAsync("localStorage.removeItem", "role");

        if (AuthStateProvider is CustomAuthStateProvider customProvider)
        {
            customProvider.NotifyUserLogout();
        }

        Navigation.NavigateTo("/login", forceLoad: true);
    }
}